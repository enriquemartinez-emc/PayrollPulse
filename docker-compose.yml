services:
  postgres:
    image: postgres:17
    container_name: payroll_postgres
    restart: always
    environment:
      POSTGRES_USER: payroll_user
      POSTGRES_PASSWORD: payroll_pass
      POSTGRES_DB: payroll_db
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U payroll_user -d payroll_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  pgadmin:
    image: dpage/pgadmin4
    container_name: payroll_pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@admin.com
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "8081:80"
    depends_on:
      - postgres

  ollama:
    image: ollama/ollama:latest
    container_name: payroll_ollama
    restart: always
    ports:
      - "11434:11434"
    volumes:
      - ollama_models:/root/.ollama
    environment:
      - OLLAMA_KEEP_ALIVE=24h
    healthcheck:
      test: ["CMD", "ollama", "list"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 300s

  ollama-init:
    image: curlimages/curl:latest
    depends_on:
      ollama:
        condition: service_healthy
    command: >
      curl -X POST http://ollama:11434/api/generate
      -d '{"model":"phi3:mini","prompt":"why the sky is blue? Be concise."}'
    restart: "no"

  api:
    build:
      context: ./backend/Payroll
      dockerfile: ./src/Payroll/Dockerfile
    container_name: payroll_api
    restart: always
    environment:
      ASPNETCORE_ENVIRONMENT: "Docker"
      ASPNETCORE_URLS: "http://+:8080"
      ConnectionStrings__Default: "Host=postgres;Port=5432;Database=payroll_db;Username=payroll_user;Password=payroll_pass"
      Ollama__Uri: "http://ollama:11434"
      Ollama__Model: "phi3:mini"
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
      pgadmin:
        condition: service_started
      ollama:
        condition: service_healthy
      ollama-init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD-SHELL", "dotnet --info > /dev/null && exit 0 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  nuxt:
    build:
      context: ./frontend
      dockerfile: ./Dockerfile
      target: runner
    container_name: payroll_nuxt
    restart: always
    environment:
      NUXT_PUBLIC_API_URL: "http://localhost:8080/api"
      NUXT_PORT: "3000"
      NODE_ENV: "production"
    ports:
      - "3000:3000"
    depends_on:
      api:
        condition: service_healthy

volumes:
  pgdata:
  ollama_models:
